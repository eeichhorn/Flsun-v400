#   _____             __ _                       _   _                
#  / ____|           / _(_)                     | | (_)                
# | |     ___  _ __ | |_ _  __ _ _   _ _ __ __ _| |_ _  ___  _ __  ___ 
# | |    / _ \| '_ \|  _| |/ _` | | | | '__/ _` | __| |/ _ \| '_ \/ __|
# | |___| (_) | | | | | | | (_| | |_| | | | (_| | |_| | (_) | | | \__ \
#  \_____\___/|_| |_|_| |_|\__, |\__,_|_|  \__,_|\__|_|\___/|_| |_|___/
#                           __/ |                                      
#                          |___/    
#
# Klipper Configurations - Flsun V400
#
# Guislain Cyril


########################################
# Firmware Settings
########################################

# MKS Robin Nano V2.0

# When running "make menuconfig"
#
# [*] Enable extra low-level configuration options
#     Micro-controller Architecture (STMicroelectronics STM32)  --->
#     Processor model (STM32F103)  --->
# [ ] Only 10KiB of RAM (for rare stm32f103x6 variant)  (NEW)
# [ ] Disable SWD at startup (for GigaDevice stm32f103 clones)  (NEW)
#     Bootloader offset (28KiB bootloader)  --->
#     Clock Reference (8 MHz crystal)  --->
#     Communication interface (Serial (on USART3 PB11/PB10))  --->
# (250000) Baud rate for serial port
# ()  GPIO pins to set at micro-controller startup
#
# Note that the "make flash" command does not work with MKS Robin
# boards. After running "make", run the following command:
#   ./scripts/update_mks_robin.py out/klipper.bin out/Robin_nano35.bin
# Copy the file out/Robin_nano35.bin to an microSD card, 
# insert it in the printer and restart it.


########################################
# Editable Settings
########################################

# Notes: Some settings can be enabled or disabled by removing or adding the '#' symbol
#
# PID (pid_Kp, pid_Ki, pid_Kd) --> [extruder] and [heater_bed] sections
# E-Steps Extruder (rotation_distance) --> [extruder] section --> <rotation_distance> = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>
# Pressure Advance (pressure_advance) --> [extruder] section -- See: https://www.klipper3d.org/Pressure_Advance.html
# Firmware Retraction --> [firmware_retraction] section -- Requires "Klipper Settings Plugin" for Cura -- See: https://github.com/jjgraphix/KlipperSettingsPlugin
# ADXL345 function for resonance testing --> Enable/Disable [include adxl345_pico.cfg] or [include adxl345_fysetc.cfg] -- Configuration in [input_shaper] section -- See: https://www.klipper3d.org/Measuring_Resonances.html
# NeoPixels function --> Enable/Disable [include neopixels.cfg]
#Timelapse function --> Enable/Disable [include timelapse.cfg]


########################################
# Included Files
########################################

[include macros.cfg]
#[include adxl345.cfg]  #Enable if you want to use ADXL

[include timelapse.cfg]  #Enable if you want to use Timelapse
#[include neopixels.cfg]  #Enable if you want to use Neopixels


########################################
# Printer Settings
########################################

[printer]
kinematics: delta
max_velocity: 400
max_accel: 8000
max_accel_to_decel: 5000
square_corner_velocity: 5
max_z_velocity: 400
print_radius: 152
minimum_z_position: -5
#delta_radius: 152


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_a]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA15
homing_speed: 50
homing_retract_dist: 5.0
homing_retract_speed: 10
#angle: 210
#position_endstop: 415.0
#arm_length = 345.0

[tmc2209 stepper_a]
uart_pin: PD5
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Y Stepper Motor & Driver Settings
########################################

[stepper_b]
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA12
#angle: 330

[tmc2209 stepper_b]
uart_pin: PD7
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Z Stepper Motor & Driver Settings
########################################

[stepper_c]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC4
#angle: 90

[tmc2209 stepper_c]
uart_pin: PD4
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Extruder & Driver Settings
########################################

[extruder]
step_pin: PD6
dir_pin: !PD3
enable_pin: !PB3
microsteps: 16
rotation_distance: 4.545 # original was 4.5
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: -5
max_temp: 315
max_extrude_cross_section: 50
max_extrude_only_distance: 800
pressure_advance: .039  # ORIGINAL 0.02
#pressure_advance_smooth_time: 0.01
#control = pid
#pid_kp = 17.501
#pid_ki = 0.711
#pid_kd = 107.630

[tmc2209 extruder]
uart_pin: PD9
run_current: 0.900
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Bed Settings
########################################

[heater_bed]
heater_pin: PA0
sensor_pin: PC0
sensor_type: EPCOS 100K B57560G104F
min_temp: -5
max_temp: 120
#control = pid
#pid_kp = 64.044
#pid_ki = 3.812
#pid_kd = 268.984


########################################
# Filament Sensor Settings
########################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode: M600
switch_pin: PA4


########################################
# Fans Settings
########################################

[fan]
pin: PB1

[heater_fan Hotend] 
pin: PB0
heater_temp: 50.0


########################################
# Probe Settings
########################################

[probe]
pin: !PA11
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 10
lift_speed: 50
samples: 5
samples_result: average
sample_retract_dist: 3
samples_tolerance: 0.02
samples_tolerance_retries: 5


########################################
# Delta Calibration & Mesh Settings
########################################

[delta_calibrate]
radius: 147
horizontal_move_z: 23
speed: 50

[bed_mesh]
speed: 80
horizontal_move_z: 23
mesh_radius: 147
mesh_origin: 0,0
mesh_pps: 5,5
round_probe_count: 5
algorithm: bicubic
#cubic_tension: 0.1
move_check_distance: 3
round_probe_count: 25 #9 # 9*9
#fade_start: 1
#fade_end: 30 


########################################
# Temperature Controls
########################################

[verify_heater extruder]
max_error: 500
hysteresis: 20

[verify_heater heater_bed]
max_error: 120
hysteresis: 5


########################################
# Firmware Retraction Settings
########################################

[firmware_retraction]
retract_length: 0.7
retract_speed: 40
unretract_extra_length: 0.05
unretract_speed: 40


########################################
# Input Shaper Settings
########################################

[input_shaper]
#shaper_freq_x: 34.78
#shaper_type_x = mzv
#shaper_freq_y: 31.68
#shaper_type_y = mzv


########################################
# G-Code Macros & Events
########################################

[idle_timeout]
timeout: 1800

[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_arcs]
resolution: 0.1

[pause_resume]

[display_status]

[respond]

[exclude_object]

[virtual_sdcard]
path: ~/printer_data/gcodes

[endstop_phase stepper_a]
endstop_align_zero: false

[endstop_phase stepper_b]
endstop_align_zero: false

[endstop_phase stepper_c]
endstop_align_zero: false 


########################################
# MCU Settings
########################################

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[temperature_sensor Speeder_Pad]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor Motherboard]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100


########################################
# LED Settings
########################################

[output_pin LED_Hotend]
pin: PE12
pwm: False
value: 0

[output_pin LED_Logo]
pin: PD11
pwm: False
value: 1

#[neopixel NeoPixels]
#pin: PB2
#chain_count: 34
#color_order: GRB
#initial_RED: 0.0
#initial_GREEN: 0.0
#initial_BLUE: 0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 18.024
#*#
#*# [printer]
#*# delta_radius = 162.820595
#*#
#*# [stepper_a]
#*# angle = 210.211440
#*# arm_length = 345.283908
#*# position_endstop = 421.302093
#*#
#*# [stepper_b]
#*# angle = 330.066365
#*# arm_length = 345.475012
#*# position_endstop = 420.044301
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 345.924580
#*# position_endstop = 420.728687
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.255
#*# pid_ki = 1.217
#*# pid_kd = 84.312
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.433
#*# pid_ki = 2.139
#*# pid_kd = 647.564
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 41/64
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 42/64
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 2/64
#*#
#*# [delta_calibrate]
#*# height0 = 18.024
#*# height0_pos = 32257.400,32158.800,32215.600
#*# height1 = 18.024
#*# height1_pos = 38670.000,38529.800,29020.800
#*# height2 = 18.024
#*# height2_pos = 31752.000,42168.000,31693.000
#*# height3 = 18.024
#*# height3_pos = 29165.400,37467.400,37505.400
#*# height4 = 18.024
#*# height4_pos = 31454.000,31375.400,38923.000
#*# height5 = 18.024
#*# height5_pos = 36577.000,29217.000,36544.000
#*# height6 = 18.024
#*# height6_pos = 40505.200,31471.600,31535.200
#*# distance0 = 97.4598
#*# distance0_pos1 = 33417.080,33750.259,33811.580
#*# distance0_pos2 = 30839.408,37588.120,37642.527
#*# distance1 = 97.636
#*# distance1_pos1 = 33559.395,33461.731,33957.140
#*# distance1_pos2 = 32901.527,32818.915,40506.999
#*# distance2 = 97.512
#*# distance2_pos1 = 33847.910,33318.343,33811.580
#*# distance2_pos2 = 37666.944,30740.662,37642.527
#*# distance3 = 97.4358
#*# distance3_pos1 = 33994.155,33460.943,33523.056
#*# distance3_pos2 = 40543.992,32807.063,32874.705
#*# distance4 = 97.462
#*# distance4_pos1 = 33849.282,33749.462,33380.062
#*# distance4_pos2 = 37692.131,37573.492,30802.377
#*# distance5 = 97.594
#*# distance5_pos1 = 33560.752,33895.420,33523.056
#*# distance5_pos2 = 32921.936,40445.272,32874.705
#*# distance6 = 97.49
#*# distance6_pos1 = 30994.189,36776.007,37334.586
#*# distance6_pos2 = 33097.835,32595.955,40188.887
#*# distance7 = 97.646
#*# distance7_pos1 = 33070.416,32567.937,39569.123
#*# distance7_pos2 = 37736.836,30792.007,37199.084
#*# distance8 = 97.484
#*# distance8_pos1 = 37360.796,30895.702,36831.149
#*# distance8_pos2 = 40226.814,33003.405,32652.177
#*# distance9 = 97.64
#*# distance9_pos1 = 39607.020,32975.702,32624.545
#*# distance9_pos2 = 37248.420,37643.060,30854.077
#*# distance10 = 97.274
#*# distance10_pos1 = 36879.488,37266.592,30957.773
#*# distance10_pos2 = 32698.663,40127.702,33071.094
#*# distance11 = 97.54
#*# distance11_pos1 = 32670.366,39507.920,33042.999
#*# distance11_pos2 = 30890.496,37144.521,37711.645
#*#
#*# [bed_mesh default_9Probe]
#*# version = 1
#*# points =
#*# 	-0.082554, -0.082554, -0.082554, -0.082554, -0.082554, -0.082554, -0.082554, -0.082554, -0.082554
#*# 	-0.070493, -0.070493, -0.070493, -0.065240, -0.037674, 0.037275, 0.109356, 0.109356, 0.109356
#*# 	0.022716, 0.022716, -0.007244, 0.001405, 0.023744, 0.041113, 0.089976, 0.086425, 0.086425
#*# 	0.095172, 0.095172, 0.049667, 0.063971, 0.057586, 0.031608, 0.014754, -0.015958, -0.015958
#*# 	0.100373, 0.044735, 0.068938, 0.091054, 0.055191, 0.037100, 0.012914, -0.023091, -0.062963
#*# 	0.124050, 0.124050, 0.069948, 0.070692, 0.047586, 0.024269, -0.036330, -0.050948, -0.050948
#*# 	-0.015043, -0.015043, -0.023961, 0.028644, 0.038840, 0.035860, 0.006305, -0.033024, -0.033024
#*# 	-0.099154, -0.099154, -0.099154, -0.013261, 0.035965, 0.014500, 0.058047, 0.058047, 0.058047
#*# 	0.014937, 0.014937, 0.014937, 0.014937, 0.014937, 0.014937, 0.014937, 0.014937, 0.014937
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 5
#*# mesh_y_pps = 5
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -147.0
#*# max_x = 147.0
#*# min_y = -147.0
#*# max_y = 147.0
#*#
#*# [bed_mesh default_25Probe]
#*# version = 1
#*# points =
#*# 	-0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554, -0.067554
#*# 	-0.107036, -0.107036, -0.107036, -0.107036, -0.107036, -0.107036, -0.107036, -0.107036, -0.107036, -0.099066, -0.096925, -0.091696, -0.071208, -0.069941, -0.037786, 0.010457, 0.097935, 0.097935, 0.097935, 0.097935, 0.097935, 0.097935, 0.097935, 0.097935, 0.097935
#*# 	-0.157774, -0.157774, -0.157774, -0.157774, -0.157774, -0.157774, -0.157774, -0.188431, -0.145895, -0.123747, -0.089113, -0.058072, 0.010141, -0.042150, -0.004462, 0.045218, 0.086182, 0.138666, 0.148242, 0.148242, 0.148242, 0.148242, 0.148242, 0.148242, 0.148242
#*# 	-0.075984, -0.075984, -0.075984, -0.075984, -0.075984, -0.075984, -0.057993, -0.060495, -0.074121, -0.045240, -0.056859, -0.045043, -0.025365, -0.021134, 0.001780, 0.047275, 0.077133, 0.058319, 0.049356, 0.107975, 0.107975, 0.107975, 0.107975, 0.107975, 0.107975
#*# 	-0.056535, -0.056535, -0.056535, -0.056535, -0.056535, -0.076524, -0.112088, -0.082339, -0.051147, -0.059059, -0.055591, -0.011433, 0.012071, 0.027086, 0.006174, 0.041687, 0.085733, 0.107027, 0.092168, 0.085072, 0.127594, 0.127594, 0.127594, 0.127594, 0.127594
#*# 	-0.029836, -0.029836, -0.029836, -0.029836, 0.006266, -0.011868, -0.008567, 0.031932, 0.025260, -0.000669, -0.014651, 0.009480, 0.022399, 0.004434, 0.009984, 0.039907, 0.060570, 0.084429, 0.104577, 0.076052, 0.085842, 0.118424, 0.118424, 0.118424, 0.118424
#*# 	0.004200, 0.004200, 0.004200, -0.022284, -0.066763, -0.001011, 0.000256, -0.001482, -0.022795, 0.013905, -0.003795, 0.020546, 0.036244, 0.058413, 0.053972, 0.061113, 0.041237, 0.064841, 0.104976, 0.109311, 0.133142, 0.088925, 0.154096, 0.154096, 0.154096
#*# 	0.066807, 0.066807, 0.066807, 0.048903, 0.054229, 0.073348, 0.049908, 0.037583, 0.059234, 0.041790, 0.037891, 0.037525, 0.031617, 0.062859, 0.036020, 0.065720, 0.038337, 0.074314, 0.073185, 0.010647, 0.016255, -0.002000, 0.052343, 0.052343, 0.052343
#*# 	0.053200, 0.053200, 0.056804, -0.017935, 0.004113, -0.025306, 0.038068, 0.034922, 0.039336, 0.073808, 0.020267, 0.059950, 0.045764, 0.037150, 0.073592, 0.053594, 0.063325, 0.077623, 0.050202, 0.034979, 0.052386, 0.028573, 0.060027, 0.050428, 0.050428
#*# 	0.073939, 0.073939, 0.094008, 0.105172, 0.079409, 0.049825, 0.049667, 0.086405, 0.074753, 0.076471, 0.076742, 0.040548, 0.065086, 0.021826, 0.016175, 0.044108, 0.049335, 0.042209, 0.024754, -0.012159, -0.016059, -0.023458, -0.008036, -0.052277, -0.052277
#*# 	0.088740, 0.088740, 0.038348, 0.085580, 0.040308, 0.044551, 0.035315, 0.090809, 0.067876, 0.058577, 0.058891, 0.079052, 0.074640, 0.031342, 0.033467, 0.040539, 0.097441, 0.052231, 0.053249, 0.038855, 0.013974, 0.026188, 0.010790, -0.037864, -0.037864
#*# 	0.142278, 0.142278, 0.169630, 0.103390, 0.114960, 0.076715, 0.101632, 0.113484, 0.079147, 0.084362, 0.086519, 0.054954, 0.036038, 0.025225, 0.047701, 0.060743, 0.051195, 0.047266, 0.005510, 0.000164, -0.008125, -0.034795, -0.089514, -0.085542, -0.085542
#*# 	0.107873, 0.068011, 0.052544, 0.044735, 0.057984, 0.092292, 0.068938, 0.116294, 0.117216, 0.098554, 0.089768, 0.053193, 0.067691, 0.054408, 0.015748, 0.042100, 0.051000, 0.066175, 0.015414, 0.006056, 0.003866, -0.008091, -0.015679, -0.062193, -0.062963
#*# 	0.124274, 0.124274, 0.097247, 0.145012, 0.118589, 0.121789, 0.101915, 0.075079, 0.086348, 0.128302, 0.110885, 0.079222, 0.028854, 0.057326, 0.026990, 0.020533, 0.023406, 0.031385, -0.036452, -0.035048, -0.034876, -0.050619, -0.076513, -0.082705, -0.082705
#*# 	0.081649, 0.081649, 0.106761, 0.094133, 0.051863, 0.079698, 0.068334, 0.095228, 0.082054, 0.062380, 0.078704, 0.047846, 0.015666, 0.066817, 0.058194, 0.049642, 0.068567, 0.007171, 0.002749, 0.001491, 0.016235, 0.020087, -0.060681, -0.093884, -0.093884
#*# 	0.092065, 0.092065, 0.118654, 0.126550, 0.076319, 0.055052, 0.059948, 0.076871, 0.067299, 0.070971, 0.089736, 0.088929, 0.025086, 0.051786, 0.053809, 0.024269, 0.031548, -0.005534, -0.056330, -0.048952, -0.068598, -0.103448, -0.109667, -0.115056, -0.115056
#*# 	0.074503, 0.074503, 0.023179, 0.019083, 0.020136, 0.037353, 0.014390, 0.045325, 0.045157, 0.033396, 0.024717, 0.094534, 0.085321, 0.045975, 0.056735, 0.030616, 0.054979, 0.026227, -0.020536, -0.014119, -0.040854, -0.042680, -0.086170, -0.158349, -0.158349
#*# 	0.040309, 0.040309, 0.040309, 0.021648, 0.032902, 0.011011, 0.012499, 0.038028, 0.040908, 0.039099, 0.040319, 0.069400, 0.077453, 0.065374, 0.064684, -0.008792, 0.015479, 0.025413, -0.025698, -0.048480, -0.062047, -0.077930, -0.110507, -0.110507, -0.110507
#*# 	-0.008055, -0.008055, -0.008055, -0.050043, -0.037974, -0.049667, -0.021461, 0.020666, -0.010302, 0.021144, 0.013972, 0.028863, 0.033840, 0.020145, 0.040454, 0.038360, 0.081749, 0.055584, 0.016305, -0.005399, -0.027122, -0.045524, -0.105930, -0.105930, -0.105930
#*# 	-0.063555, -0.063555, -0.063555, -0.063555, -0.049344, -0.039936, -0.035808, -0.009707, 0.028370, 0.021130, 0.007482, -0.011494, 0.053127, 0.011164, 0.015225, 0.069473, 0.039722, 0.029692, 0.001583, -0.004355, -0.024780, -0.071182, -0.071182, -0.071182, -0.071182
#*# 	-0.073489, -0.073489, -0.073489, -0.073489, -0.073489, -0.116025, -0.061157, -0.059851, -0.060043, -0.011917, 0.015551, -0.019741, 0.016191, 0.016213, 0.012005, 0.032974, 0.042685, 0.073818, 0.046767, 0.053908, 0.024969, 0.024969, 0.024969, 0.024969, 0.024969
#*# 	-0.130604, -0.130604, -0.130604, -0.130604, -0.130604, -0.130604, -0.109154, -0.085708, -0.048499, -0.028261, -0.036616, -0.033713, 0.035965, -0.003617, -0.012185, 0.002000, 0.055173, 0.031538, 0.038047, 0.027379, 0.027379, 0.027379, 0.027379, 0.027379, 0.027379
#*# 	-0.123617, -0.123617, -0.123617, -0.123617, -0.123617, -0.123617, -0.123617, -0.126077, -0.114915, -0.087476, -0.096931, -0.005149, -0.001441, -0.020255, 0.033629, 0.009582, 0.027659, 0.027712, 0.053574, 0.053574, 0.053574, 0.053574, 0.053574, 0.053574, 0.053574
#*# 	-0.142278, -0.142278, -0.142278, -0.142278, -0.142278, -0.142278, -0.142278, -0.142278, -0.142278, -0.110087, -0.084578, -0.075708, -0.018764, -0.023579, -0.006547, 0.035051, 0.066435, 0.066435, 0.066435, 0.066435, 0.066435, 0.066435, 0.066435, 0.066435, 0.066435
#*# 	-0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563, -0.022563
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 5
#*# mesh_y_pps = 5
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -147.0
#*# max_x = 147.0
#*# min_y = -147.0
#*# max_y = 147.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 52.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 56.0
